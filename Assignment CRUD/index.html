<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="" />
  <link rel="icon" href="favicon.png">
  <link href="assets/style.css" rel="stylesheet" type="text/css"/>
</head>
<script>
</script>
<body>
   

   <div class="container">
        <form id="form">
            
            <div class="imgcontainer">
            <h1>Login</h1>
            </div>
        
            <div class="container">
            <label for="email"><b>Email</b></label>
            <input type="text" placeholder="Enter Email" name="email" id="email">
        
            <label for="password"><b>Password</b></label>
            <input type="password" placeholder="Enter Password" name="password" id="password">
            <span id="error"></span>
            <button class="button" type="submit">Submit</button>
            <label>
                <input type="checkbox" checked="checked" name="remember"> Remember me
            </label>

            </div>
        
        </form>

<div id="tablecrud">
        <div class="nav">
            <ul>
                
                <li style="float:right"><a class="active" href="#about">Logout</a></li>
            </ul>
        </div>

        <div id="crud">
            
            <h1>CRUD Operations</h1>

            <table id="table">
                <button class="add-btn .action-buttons" id="addbtn" style="background-color: #36d770; width: 15%;margin-left: 85%;">Add</button>

                <colgroup>
                    <col/>
                    <col/>
                    <col/>
                    <col/>
                    <col/>
                    
                </colgroup>
                <tr>
                    <th><span></span>Sr.No</th>
                    <th><span></span>Email</th>
                    <th><span></span>Password</th>
                    <th><span></span>Age</th>
                    <th><span></span>ACTION</th>
                </tr>
                <tbody id="table-body"></tbody>
            </table>
        </div>

    </div>
</div>



    <!--Modal ADD-->

    <div id="addModal" class="modal">
        <div class="modal-content">
          <span id="closeAdd" class="close">&times;</span>

          <h3>Add New Record</h3>
            <form id="crudform">
            <div>
                <label for="email1">Email:</label>
                <input type="text" id="email1" name="email1" required>
            </div>
            <div>
                <label for="password1">PASSWORD:</label>
                <input type="text" id="password1" name="password1" required>
            </div>
            <div>
                <label for="age1">AGE:</label>
                <input type="text" id="age1" name="age1" required>
            </div>
           
            <button id="add-btn">Add</button>
        </form>
        </div>
      
      </div>
   


    <!--Modal Update-->
    <div id="upModal" class="modal">
        <div class="modal-content">
            <span id="closeUpdate" class="close">&times;</span>
            <h3>Update Record</h3>
            <form id="crudform1">
                <div>
                    <label for="email2">Email:</label>
                    <input type="text" id="email2" name="email2" required>
                </div>
                <div>
                    <label for="password2">Password:</label>
                    <input type="text" id="password2" name="password2" required>
                </div>
                <div>
                    <label for="age2">Age:</label>
                    <input type="text" id="age2" name="age2" required>
                </div>
                <button id="update-btn">Submit</button>
            </form>
        </div>
    </div>
   
    <script>


    // LOGGING IN------------------------------------------------------------------------------

        document.addEventListener("DOMContentLoaded", function() {

        var form = document.getElementById("form");
        var crud =document.getElementById("tablecrud");

         crud.style.display ="none";                             // uncomment
       //form.style.display="none";                                  //remove

            // Load user data from example.json
            fetch("assets/example.json")
                .then(response => response.json())
                .then(jsonData => {

                // Store the JSON data in local storage
                localStorage.setItem('jsonData', JSON.stringify(jsonData));

                const form = document.getElementById("form");
                form.addEventListener("submit", function(event) {
                    event.preventDefault();
                    const email = document.getElementById("email").value;
                    const password = document.getElementById("password").value;
                    
                    let x = document.forms["form"]["email"].value;
                    let y = document.forms["form"]["password"].value;
                    var error = document.getElementById("error");
                    if(x=="" && y=="")
                    {
                        error.textContent = "Please fill the form first"
                        error.style.color = "red"   
                        return false;
                    }
                    else{
                            if (x == "") {
                                error.textContent = "Email must be filled out"
                                error.style.color = "red"   
                                return false; 
                            }
                            else if(y=="")
                            {
                                error.textContent = "Password must be filled out"
                                error.style.color = "red";   
                                return false;
                            }
                            else{

                                // Check if the entered credentials match any user in the example.json file
                                const isValidUser = jsonData.some(function(user) {
                                return user.EMAIL === email && user.PASS === password;
                                });

                                if (isValidUser) {
                                    alert("Login successful!");
                                    form.style.display="none";
                                    crud.style.display="block";
                                } else {
                                    error.textContent = "Invalid email or password"
                                    error.style.color = "red";   
                                }
                                
                            }
                        }
                    
                });

                })
                .catch(error => console.error("Error:", error));
                
        });

    // GET DATA IN TABLE ON PAGE LOAD --------------------------------------------------------------------------

         //loading data from json file into table
         document.addEventListener( "DOMContentLoaded", get_json_data, false ); 

        
        function get_json_data() {
            // Data from local storage
            const jsonDataString = localStorage.getItem('jsonData');

            if (jsonDataString) {
                // Parse the JSON string into a JavaScript object
                const jsonData = JSON.parse(jsonDataString);

                // Get the table body element
                const tableBody = document.getElementById('table-body');

                // Clear existing table rows
                tableBody.innerHTML = '';

                // Loop through the data and create table rows
                jsonData.forEach((item, index) => {
                    // Create a table row
                    const row = document.createElement('tr');

                    // Create table cells for each property in the object
                    Object.values(item).forEach(value => {
                        const cell = document.createElement('td');
                        cell.textContent = value;
                        row.appendChild(cell);
                    });

                    // Create action buttons cell
                    const actionsTd = document.createElement('td');
                    const editBtn = document.createElement('button');
                    editBtn.className = "edit-btn";
                    editBtn.innerText = "Edit";
                    editBtn.addEventListener('click', () => {
                        showUpdateForm(item.SR)

                    });
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = "delete-btn";
                    deleteBtn.innerText = "Delete";
                    deleteBtn.addEventListener('click', () => {
                        confirmDelete(item.SR);
                    });
                    actionsTd.appendChild(editBtn);
                    actionsTd.appendChild(deleteBtn);
                    row.appendChild(actionsTd);

                    // Append the row to the table body
                    tableBody.appendChild(row);

                });
            } else {
                // Display a message if no data found in local storage
                console.log('No data found in local storage.');
            }
        }



        //VARIABLES
        const passInput = document.getElementById("password1");
        const emailInput = document.getElementById("email1");
        const ageInput = document.getElementById("age1");
        const addBtn = document.getElementById("add-btn");
        const tableBody = document.getElementById("table-body");
        const updatePasswordInput = document.getElementById("password2");
        const updateEmailInput = document.getElementById("email2");
        const updateAgeInput = document.getElementById("age2");
        const updateBtn = document.getElementById("update-btn");

        let jsonData = JSON.parse(localStorage.getItem("jsonData")) || [];
        let currentUserId = null;
        const validRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;

    // ADDING USERS ------------------------------------------------------------------------------------

        //for rendering data into table
        function renderTable(jsonData) {
            tableBody.innerHTML = "";
            for (let i = 0; i < jsonData.length; i++) {
                const user = jsonData[i];
                const tr = document.createElement("tr");
                const idTd = document.createElement("td");
                const emailTd = document.createElement("td");
                const passTd = document.createElement("td");
                const ageTd = document.createElement("td");
                const actionsTd = document.createElement("td");
                const editBtn = document.createElement("button");
                editBtn.className = "edit-btn";
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "delete-btn";
                idTd.innerText = user.SR;
                passTd.innerText = user.PASS;
                emailTd.innerText = user.EMAIL;
                ageTd.innerText = user.AGE;
                editBtn.innerText = "Edit";
                deleteBtn.innerText = "Delete";
                editBtn.addEventListener("click", () => {
                    showUpdateForm(user.SR);
                });
                deleteBtn.addEventListener("click", () => {
                    confirmDelete(user.SR);
                });
                actionsTd.appendChild(editBtn);
                actionsTd.appendChild(deleteBtn);
                tr.appendChild(idTd);
                tr.appendChild(emailTd);
                tr.appendChild(passTd);
                tr.appendChild(ageTd);
                tr.appendChild(actionsTd);
                tableBody.appendChild(tr);
            }
        }

        // Event Listeners
        addBtn.addEventListener("click", addUser);

        function addUser() {
            const password = passInput.value.trim();
            const email = emailInput.value.trim();
            const age = ageInput.value.trim();
            if (email.match(validRegex)) {
                if (password && email && age != null) {
                    // Get the existing data from local storage
                    let jsonData = JSON.parse(localStorage.getItem('jsonData')) || [];

                    // Find the maximum ID in the existing data
                    let maxId = 0;
                    jsonData.forEach(user => {
                        if (user.SR > maxId) {
                            maxId = user.SR;
                        }
                    });

                    // Increment the maximum ID to get a new unique ID
                    const id = parseInt(maxId) + 1;


                    // Create a new user object
                    const user = {
                        SR: id,
                        EMAIL: email,
                        PASS: password,
                        AGE: age,
                    };


                    // Push the new user object to the existing data
                    jsonData.push(user);

                    // Update the data in local storage
                    localStorage.setItem("jsonData", JSON.stringify(jsonData));

                    // Clear input fields
                    passInput.value = "";
                    emailInput.value = "";
                    
                    // Render the updated table
                    renderTable(jsonData);
                } else {
                    alert("Password is Required");
                }
            } else {
                alert("Invalid email address!");
            }
        }


    // UPDATE USER ---------------------------------------------------------------------------------
    
            function editUser(userId) {
            
                // Find the user with the given ID
                const userToUpdate = jsonData.find(user => user.SR === userId);
                const upmodal =document.getElementById("upModal");

                // Populate the input fields in the update modal with the existing data
                updateEmailInput.value = userToUpdate.EMAIL;
                updatePasswordInput.value = userToUpdate.PASS;
                updateAgeInput.value = userToUpdate.AGE;

                // Show the update modal
                document.getElementById("upModal").style.display = "block";
                var span = document.getElementById("closeUpdate");

                // When the user clicks on <span> (x), close the upmodal
                span.onclick = function() {
                    upmodal.style.display = "none";
                }

                // When the user clicks anywhere outside of the upmodal, close it
                window.onclick = function(event) {
                    if (event.target == upmodal) {
                        upmodal.style.display = "none";
                    }
                }

                // Listen for submit button click event
                updateBtn.addEventListener("click", function(event) {
                    event.preventDefault();

                    // Get the updated values from the input fields
                    const updatedEmail = updateEmailInput.value.trim();
                    const updatedPassword = updatePasswordInput.value.trim();
                    const updatedAge = updateAgeInput.value.trim();

                    // Update the user object with the new data
                    userToUpdate.EMAIL = updatedEmail;
                    userToUpdate.PASS = updatedPassword;
                    userToUpdate.AGE = updatedAge;

                    // Update the data in local storage
                    localStorage.setItem("jsonData", JSON.stringify(jsonData));

                    // Re-render the table with the updated data
                    renderTable(jsonData);

                    // Close the update modal
                    document.getElementById("upModal").style.display = "none";
                });
            }

            // Event Listeners for Edit Button
            function showUpdateForm(userId) {
                editUser(userId);
                console.log("clcked");
            }
                






    // DELETE -------------------------------------------------------------------------------------
    
        function deleteUser(userId) {
            const confirmDelete = confirm("Are you sure you want to delete this user?");
            if (confirmDelete) {
                // Filter out the user with the given ID
                jsonData = jsonData.filter(user => user.SR !== userId);

                // Update the data in local storage
                localStorage.setItem("jsonData", JSON.stringify(jsonData));

                // Re-render the table
                renderTable(jsonData);
            }
        }
    
    
        function confirmDelete(userId) {
            if (confirmDelete) {
                deleteUser(userId);
            } else {
                alert("Delete operation cancelled.");
            }
        }

    </script>


    <script>

        // ADD Modal Logic
        var modal = document.getElementById("addModal");
        var btn = document.getElementById("addbtn");

        //<span> element that closes the modal
        var span = document.getElementById("closeAdd");

        // When the user clicks the button, open the modal 
        btn.onclick = function() {
        modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }



        //EDIT modal logic
        function editModal(){
           
        }


    </script>

    <script src="assets/app.js"></script>
    <script type="text/javascript" src="assets/example.json"></script>
</body>
</html>
